<!DOCTYPE html>
{% load static %}
<html ng-app="chatApp">
<head>
    <title>Chat APP</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.indigo-pink.min.css">
    <script defer src="https://code.getmdl.io/1.1.3/material.min.js"></script>
    <script src="{% static "chat/angular.min.js" %}"></script>
    <style>
       #chat-form {
           position: fixed;
           left: 0px;
           bottom: 0px;
           width: 100%;
       }
    </style>
</head>

<body>
<section ng-controller="MessagesController" id="container">
    <header>
        <h1>Live Chat</h1>
    </header>
    <ul>
        <li ng-repeat="msg in messages track by $index">[[ msg.user ]]: [[ msg.msgText ]]</li>
    </ul>
    <footer id="chat-form" class="mdl-mini-footer">
        <form ng-submit="submit(user, msgText)">
            <div class="mdl-textfield mdl-js-textfield">
                <input class="mdl-textfield__input" type="text" ng-model="user" id="user">
                <label class="mdl-textfield__label" for="user">User</label>
                <span class="mdl-textfield__error">Input is not a valid user!</span>
            </div>
            <div class="mdl-textfield mdl-js-textfield">
                <textarea ng-model="msgText" rows="1" type="text" class="mdl-textfield__input"></textarea>
                <label class="mdl-textfield__label">Message text...</label>
           </div>
            <button type="submit"
                    class="mdl-button ml-js-button mdl-button--raised ml-js-ripple-effect ml-button--accent">
                Send Message
            </button>
        </form>
    </footer>
</section>
<script src="{% static "chat/angular-route.min.js" %}"></script>
<script src="{% static "chat/angular-animate.min.js" %}"></script>
<script src="{% static "chat/angular-websocket.min.js" %}"></script>
<script>
    var app = angular.module('chatApp', ['ngWebSocket']);
        app.config(function($interpolateProvider) {
        $interpolateProvider.startSymbol('[[');
        $interpolateProvider.endSymbol(']]');
    });

	app.factory('MessagesFactory', function($websocket) {
		var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
		var dataStream = $websocket(ws_scheme.concat('://', window.location.host, '/chat/'));

		var collection = [];

		dataStream.onMessage(function(message) {
            console.log('onMessage', message);
            collection.push(JSON.parse(message.data));
		});

        dataStream.onOpen(function(message) {
            //dataStream.send(JSON.stringify(message));
        });

		return {
            collection: collection,
            send: function(message) {
                console.log(message);
                dataStream.send(JSON.stringify(message));
            }
		};
	});

    app.controller('MessagesController', function($scope, MessagesFactory) {
        $scope.messages = MessagesFactory.collection;

        $scope.submit = function(user, msgText) {
            MessagesFactory.send({"user": user, "msgText": msgText});
            $scope.msgText = '';
        }
    });

</script>
</body>
</html>
