<!DOCTYPE html>
{% load static %}
<html ng-app="chatApp">
<head>
<title>Chat APP</title>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.6/angular.min.js"></script>
</head>

<body>
<section ng-controller="MessagesController">
	<ul>
		<li ng-repeat="msg in messages track by $index">[[ msg.user ]]: [[ msg.msgText ]]</li>
    </ul>
    <form ng-submit="submit(user, msgText)">
        <input type="text" ng-model="user" placeholder="User"/>
        <input type="text" ng-model="msgText" placeholder="Message Text" />
        <Button type="submit">Send Message</Button>
    </form>
</section>
<script src="https://code.angularjs.org/1.5.6/angular-route.min.js"></script>
<script src="https://code.angularjs.org/1.5.6/angular-animate.min.js"></script>
<script src="https://rawgit.com/gdi2290/angular-websocket/v1.0.9/angular-websocket.js"></script>
<script>
    var app = angular.module('chatApp', ['ngWebSocket']);
        app.config(function($interpolateProvider) {
        $interpolateProvider.startSymbol('[[');
        $interpolateProvider.endSymbol(']]');
    });

	app.factory('MessagesFactory', function($websocket) {
		var dataStream = $websocket('wss://localhost:8000/chat/');

		var collection = [];

		dataStream.onMessage(function(message) {
            console.log('onMessage', message);
            collection.push(JSON.parse(message.data));
		});

        dataStream.onOpen(function(message) {
					//dataStream.send(JSON.stringify(message));
        });

		return {
            collection: collection,
            send: function(message) {
                console.log(message);
                dataStream.send(JSON.stringify(message));
            }
		};
	});

    app.controller('MessagesController', function($scope, MessagesFactory) {
        $scope.messages = MessagesFactory.collection;

        $scope.submit = function(user, msgText) {
            MessagesFactory.send({"user": user, "msgText": msgText});
						$scope.user = '';
						$scope.msgText = '';
        }
    });

</script>
</body>
</html>
